<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Wishlist Robot Test</title>
    
    <link rel="stylesheet" href="../../../../../util/doh/robot/robot.css">
    <link rel="stylesheet" href="../../../../../util/doh/robot/robot.css">
    
    <script>
        var dojoConfig = {
            isDebug: true,
            aliases: [
                ["domReady", "dojo/domReady"]
            ]
        };
    </script>
    <script src="../../../../../dojo/dojo.js"></script>
    <script>
        require([
            "doh",
            "dojo",
            "dojo/window",
            "dijit/registry",
            "dojo/robot",
            "dijit/robot",
            "dijit/robotx",
            "domReady!"
        ], function(doh, dojo, win, registry){
            
            doh.robot.initRobot('../Wishlist.html?robot');
            
            var testWidget, addButton;
            doh.register("Wishlist Tests", [    
                {
                    name: "Create tests",
                    timeout: 60000,
                    setUp: function(t){
                        testWidget = dijit.byNode(dojo.doc.getElementById("testWidget"));
                    },
                    runTest: function(t){
                        t.t(testWidget);
                    }
                },
                {
                    name: "Adding a valid item to cart works properly",
                    timeout: 60000,
                    setUp: function(t) {},
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        setTimeout(function() {
                            // Get the add button
                            addButton = dojo.query(".button")[0];
                            
                            // Create success handler
                            var con = dojo.connect(testWidget.store, "add", def.getTestCallback(function(res) {
                                t.t(res);
                                dojo.disconnect(con);
                            }));
                            
                            // Go click on the name field
                            doh.robot.mouseMoveAt(testWidget.nameTextBox.focusNode, 10, 10);
                            doh.robot.mouseClick({ left: true });

                            // Type a name, go to next field, provide a price
                            doh.robot.typeKeys("Pumpkin Pie", 100, 200);
                            doh.robot.keyPress(dojo.keys.TAB, 10);
                            doh.robot.typeKeys("20.00", 100, 200);

                            // Click the add button
                            doh.robot.mouseMoveAt(addButton, 10, 10);
                            doh.robot.mouseClick({ left: true });
                            
                        }, 1000);
                        
                        return def;
                    },
                    tearDown: function(t){}
                },
                {
                    name: "Attempting to Add an invalid form creates an error",
                    timeout: 60000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        // Create invalid handler
                        var con = dojo.connect(testWidget, "_onInvalidClick", def.getTestCallback(function() {
                            t.t(true);
                            dojo.disconnect(con);
                        }));
                        
                        // Click the add button
                        doh.robot.mouseMoveAt(addButton, 10, 10);
                        doh.robot.mouseClick({ left: true });
                        
                        return def;
                    }
                },
                {
                    name: "Attempting to Add an invalid form creates an error; valid name, invalid price",
                    timeout: 60000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        // Create invalid handler
                        var con = dojo.connect(testWidget, "_onInvalidClick", def.getTestCallback(function() {
                            t.t(true);
                            dojo.disconnect(con);
                        }));
                        
                        // Click into the field
                        doh.robot.mouseMoveAt(testWidget.nameTextBox.focusNode, 10, 10);
                        doh.robot.mouseClick({ left: true });
                        
                        // Type a name, go to next field, provide a price
                        doh.robot.typeKeys("Pecan Pie", 100, 200);
                        doh.robot.keyPress(dojo.keys.TAB, 10);
                        doh.robot.typeKeys("pp", 100, 200);
                        
                        doh.robot.mouseMoveAt(addButton, 10, 10);
                        doh.robot.mouseClick({ left: true });
                        
                        return def;
                    }
                },
                {
                    name: "Fixing the errors and pressing the enter key on the 'Add' link adds the item",
                    timeout: 60000,
                    runTest:function(t) {
                        var def = new doh.Deferred();
                        
                        // Create invalid handler
                        var con = dojo.connect(testWidget.store, "add", def.getTestCallback(function(res) {
                            t.t(res);
                            dojo.disconnect(con);
                        }));
                        
                        
                        // Type a name, go to next field, provide a price
                        doh.robot.keyPress(dojo.keys.TAB, 10, { shift: true });
                        doh.robot.typeKeys("100", 100, 200);
                        doh.robot.keyPress(dojo.keys.TAB, 10);
                        doh.robot.keyPress(dojo.keys.ENTER, 10);
                        
                        return def;
                    }
                },
                {
                    name: "The store features two items at this point",
                    timeout: 60000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        testWidget.store.query({}).total.then(def.getTestCallback(function(total) {
                            t.t(total == 2);
                        }));
                        
                        return def;
                    }
                },
                {
                    name: "Sorting by price places Pumpkin Pie first",
                    timeout: 60000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        // Get the first record's id
                        var firstId = dojo.query("tr", testWidget.tbodyNode)[0].id;
                        
                        // Create invalid handler
                        var con = dojo.connect(testWidget, "_observeHandler", def.getTestCallback(function() {
                            t.t(firstId != dojo.query("tr", testWidget.tbodyNode)[0].id);
                            dojo.disconnect(con);
                        }));
                        
                        // Re-sort
                        doh.robot.mouseMoveAt(testWidget.sortPriceRadio, 10, 10);
                        doh.robot.mouseClick({ left: true });
                        
                        return def;
                    }
                },
                {
                    name: "Sorting by price descending places Pumpkin Pie last",
                    timeout: 60000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        // Get the first record's id
                        var firstId = dojo.query("tr", testWidget.tbodyNode)[0].id;
                        
                        // Create invalid handler
                        var con1 = dojo.connect(testWidget.descendingCheck, "onchange", function() {
                            var con = dojo.connect(testWidget, "_observeHandler", def.getTestCallback(function() {
                                t.t(firstId != dojo.query("tr", testWidget.tbodyNode)[0].id);
                                dojo.disconnect(con);
                            }));
                            dojo.disconnect(con1);
                        });
                        
                        // Re-sort
                        doh.robot.mouseMoveAt(testWidget.descendingCheck, 2000, 10, 2, 2);
                        doh.robot.mouseClick({ left: true });
                        
                        return def;
                    }
                },
                {
                    name: "Clicking remove button removes the item from the page and the store",
                    timeout: 6000,
                    runTest: function(t) {
                        var def = new doh.Deferred();
                        
                        // Get the first record's id
                        var firstId = dojo.query("tr", testWidget.tbodyNode)[0].id;
                        
                        // Create invalid handler
                        var con = dojo.connect(testWidget.store, "remove", function(res) {
                                
                            testWidget.store.query({}).total.then(def.getTestCallback(function(total) {
                                t.t(total == 1);
                            }));
                                
                            dojo.disconnect(con);
                        });
                        
                        // Re-sort
                        doh.robot.mouseMoveAt(dojo.query(".button", testWidget.tbodyNode)[0], 2000, 10, 2, 2);
                        doh.robot.mouseClick({ left: true });
                        
                        return def;
                    }
                }
            ]);
            
            doh.run();
        });
    </script>
</head>
</html>
